#!/usr/bin/env php
<?php

//$lib = __DIR__.'/../lib';

if (!is_dir('./docs')) {
    mkdir('./docs');
}

function getDirContents($dir, $root_prefix){
    $files = scandir($dir);
    $file_cmd = array();
    $first_dir = true;

    foreach($files as $key => $value){
        $path = realpath($dir.DIRECTORY_SEPARATOR.$value);
        $my_name = pathinfo($path, PATHINFO_FILENAME);

        if(!is_dir($path)) {
          if (pathinfo($path, PATHINFO_EXTENSION) === 'php') {
              $my_doc = $my_name . "\n" . str_repeat('-', strlen($my_name)+strlen($root_prefix)+1) . "\n";
              $file_cmd[] = "{ echo \"$my_doc\"; ./vendor/doxphp/doxphp/bin/doxphp < $path | ./vendor/doxphp/doxphp/bin/doxphp2sphinx; echo \"\n\"; } >> ./docs/$root_prefix/idx.rst";
          }
        } else if($value != "." && $value != "..") {
            if (!is_dir("./docs/$root_prefix/$my_name")) {
                mkdir("./docs/$root_prefix/$my_name");
            }
            $my_doc = "/" . $my_name . "\n" . str_repeat('=', strlen($my_name)+strlen($root_prefix)+1) . "\n";
            exec("echo \"$my_doc\" > ./docs/$root_prefix/$my_name/idx.rst");

            getDirContents($path, "$root_prefix/$my_name");

            $parent_doc = "   $my_name/idx";
            if ($first_dir) {
                $parent_doc  = ".. toctree::\n   :maxdepth: 2\n\n" . $parent_doc;
                $first_dir = false;
            }
            exec("echo \"$parent_doc\" >> ./docs/$root_prefix/idx.rst");
        }
    }

    if (!$first_dir) {
        exec("echo \"\" >> ./docs/$root_prefix/idx.rst");
    }

    foreach($file_cmd as $cmd) {
        exec($cmd);
    }
}
$prefix = 'Ridibooks';
$temp_prefix = "./docs";

foreach(explode ("/", 'Ridibooks') as $dir) {
    $temp_prefix = "$temp_prefix/$dir";
    if (!is_dir($temp_prefix)) {
        mkdir($temp_prefix);
    }
}

$root_doc = "src/" . $prefix . "\n" . str_repeat('=', strlen($prefix)+4) . "\n";
exec("echo \"$root_doc\" > ./docs/$prefix/idx.rst");

getDirContents('./src/Ridibooks', 'Ridibooks');
